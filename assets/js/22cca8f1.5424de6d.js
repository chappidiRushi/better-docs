"use strict";(globalThis.webpackChunkbetter_docs=globalThis.webpackChunkbetter_docs||[]).push([[6301],{4012(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"mongo/mongoose-schema-complete","title":"Mongoose Schema \u2013 Complete Reference Example","description":"----------------","source":"@site/docs/mongo/Usage.md","sourceDirName":"mongo","slug":"/mongo/mongoose-schema-complete","permalink":"/better-docs/docs/mongo/mongoose-schema-complete","draft":false,"unlisted":false,"editUrl":"https://github.com/chappidirushi/better-docs/tree/main/docs/mongo/Usage.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"id":"mongoose-schema-complete","title":"Mongoose Schema \u2013 Complete Reference Example","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Mongoose Queries \u2013 Complete Reference","permalink":"/better-docs/docs/mongo/mongoose-queries"},"next":{"title":"MongoDB as a Database System","permalink":"/better-docs/docs/mongo/mongodb-database-system"}}');var a=t(4848),i=t(8453);const r={id:"mongoose-schema-complete",title:"Mongoose Schema \u2013 Complete Reference Example",sidebar_position:1},o=void 0,l={},d=[{value:"Complete Schema Definition",id:"complete-schema-definition",level:2},{value:"Index Definitions",id:"index-definitions",level:2},{value:"Virtuals",id:"virtuals",level:2},{value:"Middleware (Hooks)",id:"middleware-hooks",level:2},{value:"Statics",id:"statics",level:2},{value:"Methods",id:"methods",level:2},{value:"Model Creation",id:"model-creation",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Projection (Field Selection) Examples",id:"projection-field-selection-examples",level:2},{value:"Notes",id:"notes",level:2},{value:"Caveats",id:"caveats",level:2},{value:"Discriminators (Inheritance)",id:"discriminators-inheritance",level:2},{value:"Populate (Advanced)",id:"populate-advanced",level:2},{value:"Query Helpers",id:"query-helpers",level:2},{value:"Getters &amp; Setters",id:"getters--setters",level:2},{value:"Validation Nuances",id:"validation-nuances",level:2},{value:"Aggregation Helpers",id:"aggregation-helpers",level:2},{value:"Explain / Index Hints",id:"explain--index-hints",level:2}];function c(e){const n={code:"code",h2:"h2",hr:"hr",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"complete-schema-definition",children:"Complete Schema Definition"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"import mongoose from 'mongoose';\nconst { Schema, model } = mongoose;\n\nconst UserSchema = new Schema(\n  {\n    // ===== Primitive Types =====\n    name: {\n      type: String,\n      required: true,                  // boolean | function\n      minlength: 2,                    // number\n      maxlength: 100,                  // number\n      trim: true,                      // boolean\n      lowercase: true,                 // boolean\n      uppercase: false,                // boolean\n      match: /[a-z]/i,                 // RegExp\n      index: true                      // boolean | object\n    },\n\n    age: {\n      type: Number,\n      min: 0,\n      max: 150,\n      default: 18,\n      validate: {\n        validator: Number.isInteger,   // function\n        message: 'age must be integer'\n      }\n    },\n\n    email: {\n      type: String,\n      unique: true,                    // boolean\n      sparse: true,                    // boolean\n      required: true,\n      immutable: true                  // boolean\n    },\n\n    isActive: {\n      type: Boolean,\n      default: true\n    },\n\n    // ===== Dates =====\n    lastLoginAt: {\n      type: Date,\n      default: Date.now,\n      expires: 60 * 60 * 24 * 30        // TTL seconds\n    },\n\n    // ===== Mixed / Maps =====\n    metadata: {\n      type: Schema.Types.Mixed         // any\n    },\n\n    settings: {\n      type: Map,\n      of: String                       // any schema type\n    },\n\n    // ===== Arrays =====\n    tags: {\n      type: [String],\n      validate: v => v.length <= 10    // custom validator\n    },\n\n    roles: [{\n      type: String,\n      enum: ['user', 'admin']          // string[] | object\n    }],\n\n    // ===== Subdocuments =====\n    profile: {\n      bio: String,\n      avatar: String\n    },\n\n    addresses: [{\n      city: String,\n      country: String,\n      zip: String\n    }],\n\n    // ===== ObjectId / Refs =====\n    organizationId: {\n      type: Schema.Types.ObjectId,\n      ref: 'Organization',             // model name\n      index: true\n    },\n\n    // ===== Versioned / Soft delete =====\n    deletedAt: {\n      type: Date,\n      select: false\n    }\n  },\n  {\n    // ===== Schema Options =====\n    timestamps: {\n      createdAt: 'created_at',         // boolean | string\n      updatedAt: 'updated_at'\n    },\n    versionKey: '__v',                 // string | false\n    optimisticConcurrency: true,       // boolean\n    strict: 'throw',                   // true | false | 'throw'\n    strictQuery: true,                 // boolean\n    minimize: true,                    // boolean\n    autoIndex: false,                  // boolean (prod)\n    autoCreate: false,                 // boolean\n    bufferCommands: true,              // boolean\n    bufferTimeoutMS: 10000,            // number\n    capped: false,                     // false | { size, max }\n    collection: 'users',               // string\n    discriminatorKey: '__type',        // string\n    shardKey: { organizationId: 1 },   // object\n    read: 'primary',                   // string\n    writeConcern: { w: 'majority' },   // object\n\n    toJSON: {\n      virtuals: true,\n      getters: false,\n      transform(doc, ret) {\n        delete ret._id;\n        return ret;\n      }\n    },\n\n    toObject: {\n      virtuals: true\n    }\n  }\n);\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"index-definitions",children:"Index Definitions"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// single\nUserSchema.index({ email: 1 }, { unique: true });\n\n// compound\nUserSchema.index({ organizationId: 1, email: 1 });\n\n// partial\nUserSchema.index(\n  { deletedAt: 1 },\n  { partialFilterExpression: { deletedAt: { $exists: true } } }\n);\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"virtuals",children:"Virtuals"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"UserSchema.virtual('isDeleted').get(function () {\n  return !!this.deletedAt;\n});\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"middleware-hooks",children:"Middleware (Hooks)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// document\nUserSchema.pre('save', function (next) {\n  this.updated_at = new Date();\n  next();\n});\n\n// query\nUserSchema.pre(/^find/, function () {\n  this.where({ deletedAt: null });\n});\n\n// error\nUserSchema.post('save', function (err, doc, next) {\n  if (err) return next(err);\n  next();\n});\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"statics",children:"Statics"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"UserSchema.statics.findActive = function () {\n  return this.find({ isActive: true });\n};\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"methods",children:"Methods"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"UserSchema.methods.softDelete = function () {\n  this.deletedAt = new Date();\n  return this.save();\n};\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"model-creation",children:"Model Creation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"export const User = model('User', UserSchema);\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// create\nconst user = await User.create({\n  name: 'john',\n  email: 'john@test.com',\n  roles: ['user'],\n  organizationId: orgId\n});\n\n// update\nawait User.updateOne(\n  { _id: user._id },\n  { $set: { isActive: false } },\n  { runValidators: true }\n);\n\n// find + lean\nconst users = await User.find()\n  .select('name email')\n  .lean();\n\n// transaction usage\nconst session = await mongoose.startSession();\nawait session.withTransaction(async () => {\n  await user.softDelete({ session });\n});\n\nsession.endSession();\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"projection-field-selection-examples",children:"Projection (Field Selection) Examples"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// include fields (string)\nawait User.find({}, 'name email');\n\n// include fields (object)\nawait User.find({}, { name: 1, email: 1 });\n\n// exclude fields\nawait User.find({}, { password: 0, deletedAt: 0 });\n\n// mix is NOT allowed (_id exception)\nawait User.find({}, { name: 1, _id: 0 });\n\n// select chaining\nawait User.find()\n  .select('name email')\n  .select('-deletedAt');\n\n// projection with lean\nawait User.find({}, { name: 1 })\n  .lean({ getters: false, virtuals: false });\n\n// projection in populate\nawait User.find()\n  .populate({\n    path: 'organizationId',\n    select: 'name status'   // projection on populated doc\n  });\n\n// aggregation $project\nawait User.aggregate([\n  { $match: { isActive: true } },\n  {\n    $project: {\n      name: 1,\n      email: 1,\n      isDeleted: { $cond: [{ $ifNull: ['$deletedAt', false] }, true, false] }\n    }\n  }\n]);\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["This schema intentionally combines ",(0,a.jsx)(n.strong,{children:"most real-world options"})," in one place"]}),"\n",(0,a.jsx)(n.li,{children:"Not all options should be used together in production"}),"\n",(0,a.jsxs)(n.li,{children:["Treat this as a ",(0,a.jsx)(n.strong,{children:"reference"}),", not a template"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"caveats",children:"Caveats"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Overusing schema features increases cognitive load"}),"\n",(0,a.jsx)(n.li,{children:"Global defaults matter as much as schema options"}),"\n",(0,a.jsx)(n.li,{children:"Performance must be validated with real workloads"}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"discriminators-inheritance",children:"Discriminators (Inheritance)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// base\nconst BaseUser = model('BaseUser', UserSchema);\n\n// child\nconst AdminUser = BaseUser.discriminator(\n  'AdminUser',\n  new Schema({ permissions: [String] })\n);\n\nawait AdminUser.create({ name: 'admin', email: 'a@test.com', permissions: ['*'] });\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"populate-advanced",children:"Populate (Advanced)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// populate with match + options\nawait User.find()\n  .populate({\n    path: 'organizationId',\n    match: { isActive: true },\n    select: 'name',\n    options: { lean: true }\n  });\n\n// deep populate\nawait User.find().populate({\n  path: 'organizationId',\n  populate: { path: 'ownerId', select: 'email' }\n});\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"query-helpers",children:"Query Helpers"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"UserSchema.query.active = function () {\n  return this.where({ isActive: true });\n};\n\nawait User.find().active();\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"getters--setters",children:"Getters & Setters"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"const PriceSchema = new Schema({\n  price: {\n    type: Number,\n    set: v => Math.round(v),      // setter\n    get: v => v / 100             // getter\n  }\n}, { toJSON: { getters: true } });\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"validation-nuances",children:"Validation Nuances"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// conditional required\nrequired: function () {\n  return this.roles.includes('admin');\n}\n\n// async validator\nvalidate: {\n  validator: async v => await checkExternal(v)\n}\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"aggregation-helpers",children:"Aggregation Helpers"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"UserSchema.statics.activeAgg = function () {\n  return this.aggregate([{ $match: { isActive: true } }]);\n};\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"explain--index-hints",children:"Explain / Index Hints"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"await User.find({ email: 'a@test.com' })\n  .hint({ email: 1 })\n  .explain('executionStats');\n"})})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453(e,n,t){t.d(n,{R:()=>r,x:()=>o});var s=t(6540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);