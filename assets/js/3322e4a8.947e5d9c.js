"use strict";(globalThis.webpackChunkbetter_docs=globalThis.webpackChunkbetter_docs||[]).push([[8265],{2867(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"mongo/mongoose-updates-atomic","title":"Mongoose Updates and Atomic Operations","description":"-----------------","source":"@site/docs/mongo/Mongoose Updates and Atomic Operations.md","sourceDirName":"mongo","slug":"/mongo/mongoose-updates-atomic","permalink":"/better-docs/docs/mongo/mongoose-updates-atomic","draft":false,"unlisted":false,"editUrl":"https://github.com/chappidirushi/better-docs/tree/main/docs/mongo/Mongoose Updates and Atomic Operations.md","tags":[],"version":"current","sidebarPosition":34,"frontMatter":{"id":"mongoose-updates-atomic","title":"Mongoose Updates and Atomic Operations","sidebar_position":34},"sidebar":"tutorialSidebar","previous":{"title":"Mongoose Indexes","permalink":"/better-docs/docs/mongo/mongoose-indexes"},"next":{"title":"Transactions and Sessions","permalink":"/better-docs/docs/mongo/mongoose-transactions-sessions"}}');var o=s(4848),i=s(8453);const a={id:"mongoose-updates-atomic",title:"Mongoose Updates and Atomic Operations",sidebar_position:34},r=void 0,d={},l=[{value:"1. Update Methods",id:"1-update-methods",level:2},{value:"2. Optimistic Concurrency",id:"2-optimistic-concurrency",level:2},{value:"3. Versioning (<code>__v</code>)",id:"3-versioning-__v",level:2},{value:"4. Array Updates",id:"4-array-updates",level:2},{value:"5. Upserts",id:"5-upserts",level:2},{value:"Notes",id:"notes",level:2},{value:"Caveats",id:"caveats",level:2}];function c(e){const n={blockquote:"blockquote",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"1-update-methods",children:"1. Update Methods"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Atomic update APIs that bypass document hydration unless explicitly requested"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"Model.updateOne(filter, update, options?)      // \u2192 Promise<UpdateResult>\nModel.updateMany(filter, update, options?)     // \u2192 Promise<UpdateResult>\nModel.findOneAndUpdate(filter, update, options?) // \u2192 Promise<Document|null>\nDocument.updateOne(update, options?)           // \u2192 Promise<UpdateResult>\n"})}),"\n",(0,o.jsxs)(s,{children:[(0,o.jsx)("summary",{children:"Examples"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// updateOne\nawait User.updateOne(\n  { _id: id },                    // filter: object\n  { $set: { name: 'A' } },        // update: operators | replacement\n  { upsert: false }               // options: upsert | runValidators | strict\n);\n\n// updateMany\nawait User.updateMany(\n  { status: 'inactive' },         // filter\n  { $unset: { token: 1 } },       // update\n  { multi: true }                 // multi ignored (legacy)\n);\n\n// findOneAndUpdate\nawait User.findOneAndUpdate(\n  { email },\n  { $inc: { loginCount: 1 } },\n  {\n    new: true,                    // boolean (return updated)\n    upsert: false,                // boolean\n    runValidators: true,          // boolean\n    setDefaultsOnInsert: true     // boolean\n  }\n);\n"})})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"2-optimistic-concurrency",children:"2. Optimistic Concurrency"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Detect write conflicts using version key comparison"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"{ optimisticConcurrency: true }   // schema option\n"})}),"\n",(0,o.jsxs)(s,{children:[(0,o.jsx)("summary",{children:"Examples"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"const schema = new Schema(\n  { name: String },\n  {\n    optimisticConcurrency: true,  // boolean\n    versionKey: '__v'              // string | false\n  }\n);\n\nconst doc = await Model.findById(id);\ndoc.name = 'A';\nawait doc.save();                  // throws VersionError on conflict\n"})})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsxs)(n.h2,{id:"3-versioning-__v",children:["3. Versioning (",(0,o.jsx)(n.code,{children:"__v"}),")"]}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Internal version key used for concurrency and conflict detection"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"versionKey: '__v' | false | string\n"})}),"\n",(0,o.jsxs)(s,{children:[(0,o.jsx)("summary",{children:"Examples"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// Default behavior\nawait Model.updateOne(\n  { _id: id, __v: 3 },             // version match\n  { $set: { name: 'B' }, $inc: { __v: 1 } }\n);\n\n// Disable versioning\nnew Schema({}, { versionKey: false }); // false\n\n// Custom version key\nnew Schema({}, { versionKey: 'v' });   // string\n"})})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"4-array-updates",children:"4. Array Updates"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Atomic mutations on array fields without full document replacement"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"$push | $pull | $addToSet | $pop | $pullAll | $each | $position\n"})}),"\n",(0,o.jsxs)(s,{children:[(0,o.jsx)("summary",{children:"Examples"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"await User.updateOne(\n  { _id: id },\n  {\n    $push: {\n      tags: {\n        $each: ['a', 'b'],         // array\n        $position: 0,              // number\n        $slice: 5                  // number\n      }\n    },\n    $pull: { roles: 'admin' },    // value | condition\n    $addToSet: { skills: 'js' }   // value | { $each: [] }\n  }\n);\n"})})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"5-upserts",children:"5. Upserts"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Insert-if-not-exists semantics combined with atomic updates"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"{ upsert: true }\n"})}),"\n",(0,o.jsxs)(s,{children:[(0,o.jsx)("summary",{children:"Examples"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"await User.findOneAndUpdate(\n  { email },\n  {\n    $set: { lastLogin: new Date() },\n    $setOnInsert: {\n      email,\n      role: 'user'                 // any value\n    }\n  },\n  {\n    upsert: true,                  // boolean\n    new: true,                     // boolean\n    rawResult: false               // boolean\n  }\n);\n"})})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Update methods are atomic at document level"}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"findOneAndUpdate"})," triggers middleware differently than ",(0,o.jsx)(n.code,{children:"save"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"$setOnInsert"})," only applies on insert"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"caveats",children:"Caveats"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Update queries bypass schema setters unless ",(0,o.jsx)(n.code,{children:"runValidators"})," is enabled"]}),"\n",(0,o.jsxs)(n.li,{children:["Versioning does not protect ",(0,o.jsx)(n.code,{children:"updateMany"})]}),"\n",(0,o.jsx)(n.li,{children:"Array positional operators require matching query conditions"}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>r});var t=s(6540);const o={},i=t.createContext(o);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);