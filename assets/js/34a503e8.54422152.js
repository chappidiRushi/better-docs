"use strict";(globalThis.webpackChunkbetter_docs=globalThis.webpackChunkbetter_docs||[]).push([[9248],{3905(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"mongo/mongoose-queries","title":"Mongoose Queries and Query Builder","description":"-----------------","source":"@site/docs/mongo/Mongoose Queries.md","sourceDirName":"mongo","slug":"/mongo/mongoose-queries","permalink":"/better-docs/docs/mongo/mongoose-queries","draft":false,"unlisted":false,"editUrl":"https://github.com/chappidirushi/better-docs/tree/main/docs/mongo/Mongoose Queries.md","tags":[],"version":"current","sidebarPosition":30,"frontMatter":{"id":"mongoose-queries","title":"Mongoose Queries and Query Builder","sidebar_position":30},"sidebar":"tutorialSidebar","previous":{"title":"Mongoose Middleware (Hooks)","permalink":"/better-docs/docs/mongo/mongoose-middleware"},"next":{"title":"Mongoose Population System","permalink":"/better-docs/docs/mongo/mongoose-population"}}');var r=s(4848),o=s(8453);const t={id:"mongoose-queries",title:"Mongoose Queries and Query Builder",sidebar_position:30},l=void 0,c={},d=[{value:"Query Construction",id:"query-construction",level:2},{value:"Casting and Coercion",id:"casting-and-coercion",level:2},{value:"Execution Lifecycle",id:"execution-lifecycle",level:2},{value:"Projection and Sorting",id:"projection-and-sorting",level:2},{value:"Cursor Queries",id:"cursor-queries",level:2},{value:"Explain Plans",id:"explain-plans",level:2},{value:"Notes",id:"notes",level:2},{value:"Caveats",id:"caveats",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"query-construction",children:"Query Construction"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Building query objects using the chainable Query API"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Queries are ",(0,r.jsx)(n.strong,{children:"lazy"})," until executed"]}),"\n",(0,r.jsx)(n.li,{children:"Chainable and immutable until execution"}),"\n",(0,r.jsxs)(n.li,{children:["Returns a ",(0,r.jsx)(n.code,{children:"Query"})," object, not a Promise"]}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Basic construction\nconst q = User.find({ age: { $gte: 18 } })\n  .where('status').equals('active')\n  .limit(10)\n  .skip(20);\n\n// Query is NOT executed yet\n\nawait q.exec(); // execution trigger\n\n// One-liner\nawait User.find({ role: 'admin' }).select('email').exec();\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"casting-and-coercion",children:"Casting and Coercion"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Automatic conversion of query values to SchemaTypes"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Happens before sending query to MongoDB"}),"\n",(0,r.jsx)(n.li,{children:"Driven by SchemaTypes"}),"\n",(0,r.jsxs)(n.li,{children:["Can throw ",(0,r.jsx)(n.code,{children:"CastError"})]}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Schema\nconst schema = new Schema({\n  age: Number,\n  active: Boolean,\n  createdAt: Date,\n});\n\n// String \u2192 Number\nawait User.find({ age: '42' }); // cast to 42\n\n// String \u2192 Boolean\nawait User.find({ active: 'true' }); // cast to true\n\n// Invalid cast\nawait User.find({ age: 'abc' }); // throws CastError\n\n// Disable casting (rare)\nUser.find({ age: '42' }).cast(false);\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"execution-lifecycle",children:"Execution Lifecycle"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Transition from Query object to MongoDB operation"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Execution methods: ",(0,r.jsx)(n.code,{children:"exec()"}),", ",(0,r.jsx)(n.code,{children:"then()"}),", ",(0,r.jsx)(n.code,{children:"await"})]}),"\n",(0,r.jsx)(n.li,{children:"Middleware applied before execution"}),"\n",(0,r.jsxs)(n.li,{children:["Results hydrated into documents (unless ",(0,r.jsx)(n.code,{children:"lean"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const query = User.findOne({ email });\n\n// Middleware NOT yet run\n\nconst doc = await query.exec(); // execution starts\n\n// Equivalent executions\nawait User.findById(id);\nawait User.findById(id).then(d => d);\n\n// Re-execution not allowed\nawait query.exec(); // \u274c throws error\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"projection-and-sorting",children:"Projection and Sorting"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Controlling returned fields and result order"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Projection reduces payload size"}),"\n",(0,r.jsx)(n.li,{children:"Sorting impacts index usage"}),"\n",(0,r.jsx)(n.li,{children:"Exclusion overrides inclusion rules"}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Projection (inclusion)\nawait User.find()\n  .select('email name -_id'); // include + exclude\n\n// Projection (object form)\nawait User.find().select({ email: 1, name: 1 });\n\n// Sorting\nawait User.find()\n  .sort({ createdAt: -1, email: 1 })\n  .limit(20);\n\n// Index-aware sort\n// Requires index on { createdAt: -1, email: 1 }\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"cursor-queries",children:"Cursor Queries"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Streaming large result sets using MongoDB cursors"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Avoids loading full result set into memory"}),"\n",(0,r.jsx)(n.li,{children:"Useful for batch processing"}),"\n",(0,r.jsx)(n.li,{children:"Uses Node.js streams or async iterators"}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Cursor\nconst cursor = User.find({ active: true }).cursor();\n\nfor await (const doc of cursor) {\n  process(doc);\n}\n\n// With batch size\nUser.find().cursor({ batchSize: 100 });\n\n// Stream API\nUser.find().cursor().on('data', doc => {\n  handle(doc);\n});\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"explain-plans",children:"Explain Plans"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Inspecting how MongoDB executes a query"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Interview points"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Delegates to MongoDB ",(0,r.jsx)(n.code,{children:"explain"})]}),"\n",(0,r.jsx)(n.li,{children:"Used for index validation"}),"\n",(0,r.jsx)(n.li,{children:"Does NOT return documents"}),"\n"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Examples (Node.js)"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// Default verbosity\nawait User.find({ email: 'a@b.com' }).explain();\n\n// Execution stats\nawait User.find({ age: { $gt: 30 } })\n  .explain('executionStats');\n\n// Query planner only\nawait User.find({ active: true })\n  .explain('queryPlanner');\n"})})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Queries are immutable once executed"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lean()"})," skips hydration and middleware"]}),"\n",(0,r.jsx)(n.li,{children:"Query helpers extend the Query prototype"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"caveats",children:"Caveats"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Reusing executed queries throws errors"}),"\n",(0,r.jsx)(n.li,{children:"Implicit casting can hide bugs"}),"\n",(0,r.jsx)(n.li,{children:"Sorting without indexes causes in-memory sorts"}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>l});var i=s(6540);const r={},o=i.createContext(r);function t(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);