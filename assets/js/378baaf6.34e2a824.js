"use strict";(globalThis.webpackChunkbetter_docs=globalThis.webpackChunkbetter_docs||[]).push([[6413],{3564(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>o,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"node/under the hood","title":"under the hood","description":"Below is a crisp but deep Markdown guide that ties together V8, Libuv, C++ bindings, the thread pool, and the Event Loop, using the context you shared and expanding it into a clean mental model of how Node.js works under the hood.","source":"@site/docs/node/under the hood.md","sourceDirName":"node","slug":"/node/under the hood","permalink":"/better-docs/docs/node/under the hood","draft":false,"unlisted":false,"editUrl":"https://github.com/chappidirushi/better-docs/tree/main/docs/node/under the hood.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"timers Module","permalink":"/better-docs/docs/node/timer"},"next":{"title":"url Module","permalink":"/better-docs/docs/node/url"}}');var l=s(4848),r=s(8453);const o={},c=void 0,d={},t=[{value:"\ud83c\udfd7\ufe0f Core Architecture Overview",id:"\ufe0f-core-architecture-overview",level:2},{value:"\ud83d\udd39 1. V8 Engine (JavaScript Execution)",id:"-1-v8-engine-javascript-execution",level:2},{value:"\ud83d\udd39 2. C++ Bindings (JS \u2194 Native Bridge)",id:"-2-c-bindings-js--native-bridge",level:2},{value:"\ud83d\udd39 3. Libuv (The Backbone of Async I/O)",id:"-3-libuv-the-backbone-of-async-io",level:2},{value:"\u2705 Event Loop",id:"-event-loop",level:3},{value:"\u2705 Thread Pool (Default size = 4)",id:"-thread-pool-default-size--4",level:3},{value:"\ud83d\udd39 4. The Event Loop (The Scheduler)",id:"-4-the-event-loop-the-scheduler",level:2},{value:"\ud83d\udce6 Event Loop Phases",id:"-event-loop-phases",level:3},{value:"\ud83d\udd39 5. Poll Phase (The Most Important Phase)",id:"-5-poll-phase-the-most-important-phase",level:2},{value:"\ud83d\udd39 6. Microtasks vs Macrotasks (Critical Concept)",id:"-6-microtasks-vs-macrotasks-critical-concept",level:2},{value:"\ud83e\udde9 Task Queues in Node.js",id:"-task-queues-in-nodejs",level:3},{value:"\ud83e\udde0 Execution Rule (Very Important)",id:"-execution-rule-very-important",level:3},{value:"\ud83d\udd39 7. Why <code>process.nextTick()</code> Is Dangerous",id:"-7-why-processnexttick-is-dangerous",level:2},{value:"\ud83d\udd39 8. Full Execution Flow Example",id:"-8-full-execution-flow-example",level:2},{value:"Execution Breakdown",id:"execution-breakdown",level:3},{value:"\ud83d\udd39 9. How Node Achieves High Performance",id:"-9-how-node-achieves-high-performance",level:2},{value:"\ud83d\ude80 Key Design Choices",id:"-key-design-choices",level:3},{value:"\ud83e\udde0 One-Line Mental Model",id:"-one-line-mental-model",level:2}];function h(e){const n={blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.p,{children:["Below is a ",(0,l.jsx)(n.strong,{children:"crisp but deep Markdown guide"})," that ties together ",(0,l.jsx)(n.strong,{children:"V8, Libuv, C++ bindings, the thread pool, and the Event Loop"}),", using the context you shared and expanding it into a clean mental model of ",(0,l.jsx)(n.strong,{children:"how Node.js works under the hood"}),"."]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h1,{id:"-how-nodejs-works-under-the-hood-a-clear-mental-model",children:"\ud83e\udde0 How Node.js Works Under the Hood (A Clear Mental Model)"}),"\n",(0,l.jsxs)(n.p,{children:["Node.js is ",(0,l.jsx)(n.strong,{children:"not just JavaScript"}),". It is a ",(0,l.jsx)(n.strong,{children:"runtime"})," built on top of multiple low-level systems that together enable ",(0,l.jsx)(n.strong,{children:"high-performance, non-blocking I/O"}),"."]}),"\n",(0,l.jsx)(n.p,{children:"At a high level:"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Node.js = V8 (JS execution) + Libuv (async I/O) + C++ bindings (bridge) + Event Loop (scheduler)"})}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\ufe0f-core-architecture-overview",children:"\ud83c\udfd7\ufe0f Core Architecture Overview"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"JavaScript Code\n      \u2193\nV8 Engine (executes JS)\n      \u2193\nC++ Bindings (Node APIs)\n      \u2193\nLibuv (Event Loop + Thread Pool)\n      \u2193\nOperating System (kernel, syscalls)\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-1-v8-engine-javascript-execution",children:"\ud83d\udd39 1. V8 Engine (JavaScript Execution)"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"What it does"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Compiles JavaScript \u2192 ",(0,l.jsx)(n.strong,{children:"machine code"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Executes synchronous JS"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Manages:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Call Stack"}),"\n",(0,l.jsx)(n.li,{children:"Heap memory"}),"\n",(0,l.jsx)(n.li,{children:"Garbage Collection"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Important"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["V8 is ",(0,l.jsx)(n.strong,{children:"single-threaded"})]}),"\n",(0,l.jsxs)(n.li,{children:["Blocking code here blocks ",(0,l.jsx)(n.strong,{children:"everything"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-js",children:"while (true) {} // \u274c blocks entire Node process\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-2-c-bindings-js--native-bridge",children:"\ud83d\udd39 2. C++ Bindings (JS \u2194 Native Bridge)"}),"\n",(0,l.jsxs)(n.p,{children:["Node\u2019s APIs (",(0,l.jsx)(n.code,{children:"fs"}),", ",(0,l.jsx)(n.code,{children:"net"}),", ",(0,l.jsx)(n.code,{children:"crypto"}),") are ",(0,l.jsx)(n.strong,{children:"not written in JS alone"}),"."]}),"\n",(0,l.jsx)(n.p,{children:"They are:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"JavaScript-facing APIs"}),"\n",(0,l.jsxs)(n.li,{children:["Backed by ",(0,l.jsx)(n.strong,{children:"C++ implementations"})]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Example:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-js",children:"fs.readFile('file.txt', cb);\n"})}),"\n",(0,l.jsx)(n.p,{children:"Flow:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"JS \u2192 C++ binding \u2192 Libuv \u2192 OS\n"})}),"\n",(0,l.jsx)(n.p,{children:"These bindings decide:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Should this run in the ",(0,l.jsx)(n.strong,{children:"thread pool"}),"?"]}),"\n",(0,l.jsxs)(n.li,{children:["Or be handled by ",(0,l.jsx)(n.strong,{children:"non-blocking OS APIs"}),"?"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-3-libuv-the-backbone-of-async-io",children:"\ud83d\udd39 3. Libuv (The Backbone of Async I/O)"}),"\n",(0,l.jsxs)(n.p,{children:["Libuv is a ",(0,l.jsx)(n.strong,{children:"C library"})," that provides:"]}),"\n",(0,l.jsx)(n.h3,{id:"-event-loop",children:"\u2705 Event Loop"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Schedules callbacks"}),"\n",(0,l.jsxs)(n.li,{children:["Decides ",(0,l.jsx)(n.em,{children:"when"})," JS callbacks execute"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"-thread-pool-default-size--4",children:"\u2705 Thread Pool (Default size = 4)"}),"\n",(0,l.jsxs)(n.p,{children:["Used for ",(0,l.jsx)(n.strong,{children:"blocking operations"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["File system (",(0,l.jsx)(n.code,{children:"fs"}),")"]}),"\n",(0,l.jsx)(n.li,{children:"DNS (non-OS-based)"}),"\n",(0,l.jsx)(n.li,{children:"Crypto"}),"\n",(0,l.jsx)(n.li,{children:"zlib"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-txt",children:"Thread Pool \u2260 JavaScript Threads\nJS is still single-threaded\n"})}),"\n",(0,l.jsx)(n.p,{children:"You can increase pool size:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"UV_THREADPOOL_SIZE=8\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-4-the-event-loop-the-scheduler",children:"\ud83d\udd39 4. The Event Loop (The Scheduler)"}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.strong,{children:"Event Loop"})," is a loop that runs continuously and processes tasks in ",(0,l.jsx)(n.strong,{children:"phases"}),"."]}),"\n",(0,l.jsx)(n.h3,{id:"-event-loop-phases",children:"\ud83d\udce6 Event Loop Phases"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. timers                  \u2502 setTimeout, setInterval\n\u2502 2. pending callbacks       \u2502 deferred I/O callbacks\n\u2502 3. idle, prepare           \u2502 internal\n\u2502 4. poll                    \u2502 I/O callbacks, waits here\n\u2502 5. check                   \u2502 setImmediate\n\u2502 6. close callbacks         \u2502 cleanup (socket.close)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Each iteration = ",(0,l.jsx)(n.strong,{children:"one tick"})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-5-poll-phase-the-most-important-phase",children:"\ud83d\udd39 5. Poll Phase (The Most Important Phase)"}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.strong,{children:"poll phase"})," is where Node spends most of its time."]}),"\n",(0,l.jsx)(n.p,{children:"It:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Executes I/O callbacks"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Waits for new I/O events"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Decides:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Block and wait?"})}),"\n",(0,l.jsxs)(n.li,{children:["Or move to ",(0,l.jsx)(n.code,{children:"check"})," / ",(0,l.jsx)(n.code,{children:"timers"}),"?"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-txt",children:"If poll queue is empty:\n- If timers are ready \u2192 go to timers\n- Else \u2192 wait for I/O\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-6-microtasks-vs-macrotasks-critical-concept",children:"\ud83d\udd39 6. Microtasks vs Macrotasks (Critical Concept)"}),"\n",(0,l.jsx)(n.h3,{id:"-task-queues-in-nodejs",children:"\ud83e\udde9 Task Queues in Node.js"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Type"}),(0,l.jsx)(n.th,{children:"Queue"}),(0,l.jsx)(n.th,{children:"Priority"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"process.nextTick()"})}),(0,l.jsx)(n.td,{children:"Next Tick Queue"}),(0,l.jsx)(n.td,{children:"\ud83d\udd34 Highest"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Promises"}),(0,l.jsx)(n.td,{children:"Microtask Queue"}),(0,l.jsx)(n.td,{children:"\ud83d\udfe0 High"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Timers"}),(0,l.jsx)(n.td,{children:"Timers Phase"}),(0,l.jsx)(n.td,{children:"\ud83d\udfe1 Normal"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"I/O"}),(0,l.jsx)(n.td,{children:"Poll Phase"}),(0,l.jsx)(n.td,{children:"\ud83d\udfe2 Normal"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"setImmediate"}),(0,l.jsx)(n.td,{children:"Check Phase"}),(0,l.jsx)(n.td,{children:"\ud83d\udfe2 Normal"})]})]})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"-execution-rule-very-important",children:"\ud83e\udde0 Execution Rule (Very Important)"}),"\n",(0,l.jsxs)(n.p,{children:["After ",(0,l.jsx)(n.strong,{children:"every phase"}),", Node executes:"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"process.nextTick queue"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Microtask queue (Promises)"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Before moving to the next phase."}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsxs)(n.h2,{id:"-7-why-processnexttick-is-dangerous",children:["\ud83d\udd39 7. Why ",(0,l.jsx)(n.code,{children:"process.nextTick()"})," Is Dangerous"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"process.nextTick()"})," ",(0,l.jsx)(n.strong,{children:"starves the event loop"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-js",children:"function loop() {\n  process.nextTick(loop);\n}\nloop(); // \u274c Event loop never continues\n"})}),"\n",(0,l.jsx)(n.p,{children:"Reason:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"nextTick"})," runs ",(0,l.jsx)(n.strong,{children:"before promises"})]}),"\n",(0,l.jsxs)(n.li,{children:["Runs ",(0,l.jsx)(n.strong,{children:"before event loop phases"})]}),"\n",(0,l.jsx)(n.li,{children:"Can block I/O entirely"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-8-full-execution-flow-example",children:"\ud83d\udd39 8. Full Execution Flow Example"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-js",children:"console.log('start');\n\nprocess.nextTick(() => console.log('nextTick'));\n\nPromise.resolve().then(() => console.log('promise'));\n\nsetTimeout(() => console.log('timeout'), 0);\n\nsetImmediate(() => console.log('immediate'));\n\nconsole.log('end');\n"})}),"\n",(0,l.jsx)(n.h3,{id:"execution-breakdown",children:"Execution Breakdown"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Main script (V8)"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"start\nend\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Next Tick Queue"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"nextTick\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"3",children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Microtask Queue"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"promise\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"4",children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Timers Phase"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"timeout\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"5",children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Check Phase"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"immediate\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u2705 Final Output:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"start\nend\nnextTick\npromise\ntimeout\nimmediate\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-9-how-node-achieves-high-performance",children:"\ud83d\udd39 9. How Node Achieves High Performance"}),"\n",(0,l.jsx)(n.h3,{id:"-key-design-choices",children:"\ud83d\ude80 Key Design Choices"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Single-threaded JS"})," \u2192 no locks, simple model"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Async I/O"})," \u2192 no waiting on syscalls"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Thread pool"})," \u2192 offloads blocking work"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Event loop"})," \u2192 efficient scheduling"]}),"\n"]}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsxs)(n.p,{children:["Node is fast ",(0,l.jsx)(n.strong,{children:"not because it\u2019s multi-threaded"}),",\nbut because it ",(0,l.jsx)(n.strong,{children:"avoids waiting"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"-one-line-mental-model",children:"\ud83e\udde0 One-Line Mental Model"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Node.js runs JavaScript on a single thread, offloads slow work to the OS or a thread pool, and uses the event loop to efficiently schedule callbacks back onto the main thread."})}),"\n"]}),"\n",(0,l.jsx)(n.hr,{})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>c});var i=s(6540);const l={},r=i.createContext(l);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);