"use strict";(globalThis.webpackChunkbetter_docs=globalThis.webpackChunkbetter_docs||[]).push([[5840],{7782(n,s,e){e.r(s),e.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"mongo/mongoose-transactions-sessions","title":"Transactions and Sessions","description":"-----------------","source":"@site/docs/mongo/Mongoose Transactions and Sessions.md","sourceDirName":"mongo","slug":"/mongo/mongoose-transactions-sessions","permalink":"/better-docs/docs/mongo/mongoose-transactions-sessions","draft":false,"unlisted":false,"editUrl":"https://github.com/chappidirushi/better-docs/tree/main/docs/mongo/Mongoose Transactions and Sessions.md","tags":[],"version":"current","sidebarPosition":35,"frontMatter":{"id":"mongoose-transactions-sessions","title":"Transactions and Sessions","sidebar_position":35},"sidebar":"tutorialSidebar","previous":{"title":"Mongoose Updates and Atomic Operations","permalink":"/better-docs/docs/mongo/mongoose-updates-atomic"},"next":{"title":"Delete Operations","permalink":"/better-docs/docs/mongo/mongoose-delete-operations"}}');var r=e(4848),i=e(8453);const t={id:"mongoose-transactions-sessions",title:"Transactions and Sessions",sidebar_position:35},a=void 0,c={},l=[{value:"1. Sessions in Mongoose",id:"1-sessions-in-mongoose",level:2},{value:"2. Transaction Lifecycle",id:"2-transaction-lifecycle",level:2},{value:"3. Error Handling",id:"3-error-handling",level:2},{value:"4. Retry Strategies",id:"4-retry-strategies",level:2},{value:"Notes",id:"notes",level:2},{value:"Caveats",id:"caveats",level:2}];function d(n){const s={blockquote:"blockquote",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...n.components},{Details:e}=s;return e||function(n,s){throw new Error("Expected "+(s?"component":"object")+" `"+n+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h2,{id:"1-sessions-in-mongoose",children:"1. Sessions in Mongoose"}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Logical context for grouping operations; required for transactions"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"mongoose.startSession(options?)      // \u2192 Promise<ClientSession>\n"})}),"\n",(0,r.jsxs)(e,{children:[(0,r.jsx)("summary",{children:"Examples"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"const session = await mongoose.startSession({\n  causalConsistency: true           // boolean\n});\n\n// attach to queries\nawait User.findOne({ _id: id }).session(session);\n\n// pass explicitly\nawait Order.create([{ total: 100 }], { session });\n"})})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"2-transaction-lifecycle",children:"2. Transaction Lifecycle"}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Explicit control over transaction boundaries"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"session.startTransaction(options?)\nsession.commitTransaction()\nsession.abortTransaction()\nsession.endSession()\n"})}),"\n",(0,r.jsxs)(e,{children:[(0,r.jsx)("summary",{children:"Examples"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"const session = await mongoose.startSession();\n\ntry {\n  session.startTransaction({\n    readConcern: { level: 'snapshot' }, // 'local' | 'majority' | 'snapshot'\n    writeConcern: { w: 'majority' },    // number | 'majority'\n    readPreference: 'primary'           // string\n  });\n\n  await User.updateOne(\n    { _id: userId },\n    { $inc: { balance: -100 } },\n    { session }\n  );\n\n  await Order.create([\n    { userId, amount: 100 }\n  ], { session });\n\n  await session.commitTransaction();\n} catch (err) {\n  await session.abortTransaction();\n  throw err;\n} finally {\n  session.endSession();\n}\n"})})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"3-error-handling",children:"3. Error Handling"}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Handle transient transaction errors explicitly"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"error.hasErrorLabel('TransientTransactionError')\nerror.hasErrorLabel('UnknownTransactionCommitResult')\n"})}),"\n",(0,r.jsxs)(e,{children:[(0,r.jsx)("summary",{children:"Examples"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"try {\n  await session.commitTransaction();\n} catch (err) {\n  if (err.hasErrorLabel('UnknownTransactionCommitResult')) {\n    // commit outcome unknown\n  }\n  if (err.hasErrorLabel('TransientTransactionError')) {\n    // safe to retry entire transaction\n  }\n  throw err;\n}\n"})})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"4-retry-strategies",children:"4. Retry Strategies"}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Idempotent retries for transient failures"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"withTransaction(fn, options?)\n"})}),"\n",(0,r.jsxs)(e,{children:[(0,r.jsx)("summary",{children:"Examples"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"const session = await mongoose.startSession();\n\nawait session.withTransaction(async () => {\n  await User.updateOne(\n    { _id: userId },\n    { $inc: { balance: -50 } },\n    { session }\n  );\n\n  await Ledger.create([\n    { userId, delta: -50 }\n  ], { session });\n}, {\n  readConcern: { level: 'snapshot' },\n  writeConcern: { w: 'majority' },\n  readPreference: 'primary'\n});\n\nsession.endSession();\n"})})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Transactions require replica set or sharded cluster"}),"\n",(0,r.jsx)(s.li,{children:"All operations must use the same session"}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"withTransaction"})," handles retries automatically"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"caveats",children:"Caveats"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"No transactions on standalone MongoDB"}),"\n",(0,r.jsx)(s.li,{children:"Long transactions increase lock pressure"}),"\n",(0,r.jsx)(s.li,{children:"Non-idempotent operations complicate retries"}),"\n"]})]})}function h(n={}){const{wrapper:s}={...(0,i.R)(),...n.components};return s?(0,r.jsx)(s,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},8453(n,s,e){e.d(s,{R:()=>t,x:()=>a});var o=e(6540);const r={},i=o.createContext(r);function t(n){const s=o.useContext(i);return o.useMemo(function(){return"function"==typeof n?n(s):{...s,...n}},[s,n])}function a(n){let s;return s=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),o.createElement(i.Provider,{value:s},n.children)}}}]);